parameters:
  - name: test_type
  - name: app_id
    type: string
    default: ""

steps:
    - task: s3-cache-action@1
      inputs:
        key: 'poetry | $(SERVICE_NAME) | $(Pipeline.Workspace)/s/$(SERVICE_NAME)/$(SERVICE_ARTIFACT_NAME)/poetry.lock'
        location: '$(Pipeline.Workspace)/s/$(SERVICE_NAME)/$(SERVICE_ARTIFACT_NAME)/.venv'
        debug: true
        alias: 'Pytest'
      displayName: cache pytest dependencies

    - bash: |
        make install-python
      workingDirectory: $(Pipeline.Workspace)/s/$(SERVICE_NAME)/$(SERVICE_ARTIFACT_NAME)
      condition: ne(variables['CacheRestored-Pytest'], 'true')
      displayName: Setup pytests

    - bash: |
        export SOURCE_COMMIT_ID=$(Build.SourceVersion)
        export PROXY_NAME="$(FULLY_QUALIFIED_SERVICE_NAME)"
        export APIGEE_ACCESS_TOKEN="$(secret.AccessToken)"
        export APIGEE_ORGANIZATION="nhsd-$(APIGEE_ORGANIZATION)"
        export APIGEE_APP_ID=${{ parameters.app_id }}
        export STATUS_ENDPOINT_API_KEY="$(status-endpoint-api-key)"
        make -C e2e ${{ parameters.test_type }}

      workingDirectory: $(SERVICE_DIR)
      displayName: 'Run ${{ parameters.test_type }} Tests'

    - task: PublishTestResults@2
      displayName: 'Publish ${{ parameters.test_type }} Test Results'
      inputs:
          testResultsFiles: |
              $(SERVICE_DIR)/reports/${{ parameters.test_type }}.xml
          failTaskOnFailedTests: true
